function out(e,t){t.end((e.callback||"callback")+"("+JSON.stringify(e)+");")}function saveMsg(e){mtime=e.time=+new Date,list.push({name:e.name,msg:e.msg,time:mtime})}function saveList(){if(mtime===stime);else{stime=mtime;for(var e,t=0;list.length>100;)e=list.splice(0,100),fs.writeFile("data/"+stime+"-"+t++ +".json",JSON.stringify(e,null,4));fs.writeFile("data.json",JSON.stringify(list,null,4))}setTimeout(saveList,12e4)}var fs=require("fs"),http=require("http"),url=require("url"),querystring=require("querystring"),list=JSON.parse(fs.readFileSync("data.json","utf-8")),ctime=+new Date,mtime=ctime,stime=mtime;http.createServer(function(e,t){function i(){r.time!=mtime?(r.msgList=list.filter(function(e){return e.time>r.time}),r.time=mtime,out(r,t)):s>=60?(r.msgList=[],out(r,t)):(s++,setTimeout(i,500))}var s=0,r=querystring.parse(url.parse(e.url).query);if(t.writeHead(200,{"Content-Type":"application/javascript"}),r.name=r.name||"(匿名)","/favicon.ico"===e.url.toString()){var m=new Date;m.setFullYear(m.getFullYear()+1),t.writeHead(200,{"Content-Type":"image/x-icon",Expires:m}),t.end("")}else r.time&&"POST"!==e.method&&r.method?"push"===r.method?(saveMsg(r),out(r,t)):i():(r.msg=r.msg||"加入聊天室",r.msgList=[],saveMsg(r),out(r,t))}).listen(8973),saveList();